# Module Spec: 4.data_quality.py

## 1. Module Overview
- **Name / ID:** `4.data_quality.py`  
- **Purpose:**  
  Performs automated data quality checks on the FuelCheck staging tables by calling the `public.data_quality_check()` stored procedure.  
  Logs any detected defects into the `dq_issues` table, including missing data, reference mismatches, and parsing issues.  
- **Author / Date:** Paul – 2026  

## 2. Upstream Dependencies
- Orchestrator module / GitHub Actions workflow
- Database tables:
  - `stg_fuel_price`
  - `stg_new_stations`
  - `stg_updated_stations`
  - `dim_fuel_stations`
  - `dq_issues` 
- Environment variable:
  - `DB_CONNECTION_STRING`

## 3. Downstream Dependencies
- 5.data_update.py
- Any downstream workflows consuming quality-checked staging data

## 4. Inputs / Sources
- **Database Tables:**
  - `stg_fuel_price` – fact table containing staged fuel prices
  - `stg_new_stations` – staging table for newly added stations
  - `stg_updated_stations` – staging table for updated stations
  - `dim_fuel_stations` – master dimension table of stations

- **Stored Procedure:**
  - `data_quality_check()`

## 5. Outputs
- **Database Table:**
  - `dq_issues` – populated with defect records for each check

- **Logging:**
  - Execution logs recorded in GitHub Actions workflow

## 6. Data Quality Checks

| Defect ID | Defect Type        | Description                                                                                  | SQL Logic / Check Summary |
|-----------|------------------|----------------------------------------------------------------------------------------------|---------------------------|
| AD_01     | Missing Data      | Stations in `stg_fuel_price` not found in dimension or staging tables                        | `stg_fuel_price` LEFT JOIN `dim_fuel_stations`, `stg_new_stations`, `stg_updated_stations`; insert rows where no match |
| AD_02     | Reference Mismatch| Stations marked for update but still have records under old name/address                     | `stg_fuel_price` INNER JOIN `dim_fuel_stations` and `stg_updated_stations`; find fact rows under old station info |
| AD_03     | Reference Mismatch| Stations marked for update with records under both old and new name/address                  | `stg_fuel_price` LEFT JOIN `dim_fuel_stations` and `stg_updated_stations`; count rows in both old and new, insert if both exist |
| AD_04     | Parsing Issue     | New stations with missing `street` or `town` columns                                         | SELECT from `stg_new_stations` where `street` IS NULL OR `town` IS NULL |
| AD_05     | Parsing Issue     | Updated stations with missing `street` or `town` columns                                     | SELECT from `stg_updated_stations` where `street` IS NULL OR `town` IS NULL |

## 7. Logic / Processing Overview
1. Establish connection to the PostgreSQL database using `DB_CONNECTION_STRING`.
2. Call the `data_quality_check()` stored procedure.
3. Stored procedure executes all checks listed in the table above and inserts results into `dq_issues`.
4. `ON CONFLICT` ensures duplicate defects are ignored for idempotency.
5. Logs success/failure to workflow.

## 8. Conditional Checks
- Stored procedure execution failure → raises exception
- Database connection failure → raises exception
- Any unhandled exception propagates to orchestrator and fails the workflow

## 9. Error Handling & Logging
- Log all major steps, decisions, and URLs accessed  
- Git operations wrapped in `try/except`  
- Exceptions logged with stack trace  
- Non-critical exits use `sys.exit(10)` to avoid orchestrator failure  
- Critical failures re-raised for orchestrator handling

