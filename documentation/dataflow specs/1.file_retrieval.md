# Module Spec: File Retrieval – Fuel Check

## 1. Module Overview
- **Name / ID:** `1.file_retrieval.py`  
- **Purpose:** Retrieves the latest monthly Fuel Check dataset from NSW Government, converts it to CSV, commits it to the GitHub repository, and updates runtime configuration.  
- **Author / Date:** Paul – 21 Jan 2026  

## 2. Upstream Dependencies
- Orchestrator module triggers execution  
- GitHub Actions environment  
- Environment variables:
  - `GITHUB_TOKEN`
  - `GITHUB_REPOSITORY`

## 3. Downstream Dependencies
- Data transformation module  
- Data quality module  
- Database update module  

## 4. Inputs / Sources
- **Web source:** NSW Fuel Check dataset page  
  - `https://data.nsw.gov.au/data/dataset/fuel-check`
- **Config file:** `config.json`
  - `next_file_date`
  - `latest_file`
- **Command-line arguments:**
  - `--log-file`
- **System time:** Used to determine current and previous month

## 5. Outputs
- Monthly fuel data file saved as CSV  
  - Path: `data and logs/`
  - Naming: `fuelcheck_<mon><year>.csv`
- Updated `config.json`
- Git commit containing:
  - New data file
  - Updated config file
- Workflow logs written to shared log file

## 6. Logic / Steps
1. Initialise module logging using orchestrator-provided log file
2. Load runtime configuration from `config.json`
3. Determine:
   - Last completed month
   - Current month marker for idempotency checks
4. Connect to Fuel Check dataset webpage
5. Parse HTML and identify downloadable `.csv` or `.xlsx` files matching last month
6. Conditional exits:
   - Exit if current month has already been processed
   - Exit if expected file is not yet available
7. Download matching file
8. Load file into pandas DataFrame
9. Convert and save data as CSV
10. Commit and push data file to GitHub
11. Update `config.json` with latest processed month
12. Commit and push updated config file

## 7. Conditional Checks
1. **Duplicate processing**
   - If `monthyear == next_file_date`
   - Exit without error
2. **File availability**
   - If no matching download link found
   - Exit without error
3. **File format**
   - Supports `.csv` and `.xlsx` only

## 8. Error Handling & Logging
- Log all major steps and decisions
- Git operations wrapped in `try/except`
- Exceptions logged with stack trace
- Non-critical exits use `sys.exit(10)` to avoid orchestrator failure
- Critical failures re-raised for orchestrator handling
