# Module Spec: 3.station_dictionary_sync.py

## 1. Module Overview
- **Name / ID:** `3.station_dictionary_sync.py`  
- **Purpose:**  
  Synchronises the FuelCheck API station reference data with the internal station dictionary.  
  Identifies new stations, inactive stations, and station updates (name or address changes), and loads the results into temporary tables for downstream processing.  
- **Author / Date:** Paul – 2026  

---

## 2. Upstream Dependencies
- GitHub Actions workflow (orchestrator triggered)
- Environment variables:
  - `DB_CONNECTION_STRING`
  - `API_KEY`
  - `API_SECRET`
  - `API_AUTH_HEADER`
- External API:
  - FuelCheck Reference Data API (OneGov NSW)
- PostgreSQL database

---

## 3. Downstream Dependencies
- Stored procedure:
  - `dev.truncate_temp_station_tables()`
- Dictionary maintenance process that consumes:
  - `dev.temp_new_stations`
  - `dev.temp_updated_stations`
  - `dev.temp_inactive_stations`
- Any downstream processes dependent on updated station metadata

---

## 4. Inputs / Sources

### External API
- OAuth token endpoint:
  `https://api.onegov.nsw.gov.au/oauth/client_credential/accesstoken`
- Station reference endpoint:
  `https://api.onegov.nsw.gov.au/FuelCheckRefData/v2/fuel/lovs`

### Database Table
- `dev.fuel_station_dict`
  - Active stations only (`WHERE active = TRUE`)

---

## 5. Outputs

### Temporary Tables (dev schema)
- `temp_new_stations`
- `temp_updated_stations`
- `temp_inactive_stations`

### Logging
- Execution logs written to GitHub Actions log stream

---

## 6. Logic / Processing Overview

The module performs the following operations:

1. Generates an OAuth access token using client credentials.
2. Calls the FuelCheck reference data API to retrieve station metadata.
3. Flattens the JSON response into a tabular structure.
4. Derives structured address fields:
   - `street`
   - `town`
   - `postcode`
5. Standardises formatting (title case for address components).
6. Adds a UTC `last_update` timestamp.
7. Selects and renames required fields:
   - `stationid`
   - `brand`
   - `name`
   - `address`
   - `street`
   - `town`
   - `postcode`
   - `latitude`
   - `longitude`
   - `last_update`
8. Ensures `stationid` is stored as string.

The module then retrieves the active station dictionary from the database and performs change detection:

- **New stations:** Present in API but not in dictionary.
- **Inactive stations:** Present in dictionary but not in API.
- **Updated stations:** Matching `stationid` where `name` or `address` has changed.

Before inserting results, the module:

- Executes `dev.truncate_temp_station_tables()` to clear existing temp data.
- Inserts detected changes into the respective temporary tables.

No direct updates are performed on the main dictionary table within this module.

---

## 7. Conditional Checks

- If access token generation fails → execution stops.
- If API request fails → execution stops.
- If database connection fails → exception is raised.
- If insert operations fail → workflow fails.

---

## 8. Error Handling & Logging

- API requests wrapped in try/except with HTTP error handling.
- Database calls wrapped in exception handling.
- Failures propagate to the orchestrator (non-zero exit).
- Each execution generates:
  - Unique transaction ID (UUID)
  - UTC timestamp

---

## 9. Cloud Deployment Considerations

For GitHub Actions deployment:

- Replace hardcoded credentials with environment variables.
- Replace localhost connection string with `${DB_CONNECTION_STRING}`.
- Remove embedded secrets from code.
- Use structured logging instead of print statements.
- Store API credentials in GitHub Secrets.

---

## 10. Exit Behaviour

- Successful execution → exit code 0  
- Failure → non-zero exit code (workflow fails)
