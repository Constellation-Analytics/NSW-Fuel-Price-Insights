# Module Spec: 3.station_dictionary_sync.py

## 1. Module Overview
- **Name / ID:** `3.API_Integration.py`  
- **Purpose:**  
  Synchronises the FuelCheck API station reference data with the internal station dictionary.  
  Identifies new stations, inactive stations, and station updates (name or address changes), and loads the results into temporary tables for downstream processing.  
- **Author / Date:** Paul – 2026  

## 2. Upstream Dependencies
- GitHub Actions workflow (orchestrator triggered)
- Environment variables:
  - `DB_CONNECTION_STRING`
  - `API_KEY`
  - `API_SECRET`
  - `API_AUTH_HEADER`
- External API:
  - FuelCheck Reference Data API (OneGov NSW)
- PostgreSQL database

## 3. Downstream Dependencies
- Dictionary maintenance process that consumes:
  - `stg_new_stations`
  - `stg_updated_stations`
  - `stg_inactive_stations`
- Any downstream processes dependent on updated station metadata

## 4. Inputs / Sources

### External API
- OAuth token endpoint:
  `https://api.onegov.nsw.gov.au/oauth/client_credential/accesstoken`
- Station reference endpoint:
  `https://api.onegov.nsw.gov.au/FuelCheckRefData/v2/fuel/lovs`

### Database Table
- `dim_fuel_stations`
  - Active stations only (`WHERE active = TRUE`)

## 5. Outputs

### Temporary Tables
- `stg_new_stations`
- `stg_updated_stations`
- `stg_inactive_stations`

### Logging
- Execution logs written to GitHub Actions log stream

## 6. Logic / Processing Overview

The module performs the following operations:

1. Generates an OAuth access token using client credentials.
2. Calls the FuelCheck reference data API to retrieve station metadata.
3. Flattens the JSON response into a tabular structure.
4. Derives structured address fields:
   - `street`
   - `town`
   - `postcode`
5. Standardises formatting (title case for address components).
6. Adds a UTC `last_update` timestamp.
7. Selects and renames required fields:
   - `stationid`
   - `brand`
   - `name`
   - `address`
   - `street`
   - `town`
   - `postcode`
   - `latitude`
   - `longitude`
   - `last_update`
8. Ensures `stationid` is stored as string.

The module then retrieves the active station dictionary from the database and performs change detection:

- **New stations:** Present in API but not in dictionary.
- **Inactive stations:** Present in dictionary but not in API.
- **Updated stations:** Matching `stationid` where `name` or `address` has changed.

Before inserting results, the module:

- Inserts detected changes into the respective staging tables.

No direct updates are performed on the main dictionary table within this module.

## 7. Conditional Checks

- If access token generation fails → execution stops.
- If API request fails → execution stops.
- If database connection fails → exception is raised.
- If insert operations fail → workflow fails.

## 8. Error Handling & Logging
- Log all major steps, decisions, and URLs accessed  
- Git operations wrapped in `try/except`  
- Exceptions logged with stack trace  
- Non-critical exits use `sys.exit(10)` to avoid orchestrator failure  
- Critical failures re-raised for orchestrator handling

