# Module Spec: Data Transformation – Fuel Check

## 1. Module Overview
- **Name / ID:** `2.data_transformation.py`  
- **Purpose:** Cleans, standardises, expands, and prepares Fuel Check price data into a complete daily time series ready for database loading.  
- **Author / Date:** Paul – 21 Jan 2026  

## 2. Upstream Dependencies
- Orchestrator module  
- File retrieval module (`1.file_retrieval.py`)  
- GitHub Actions environment  
- Environment variables:
  - `DB_CONNECTION_STRING`  

## 3. Downstream Dependencies
- Data quality module  
- Database update module  

## 4. Inputs / Sources
- **CSV file:** Output from Module 1  
  - Path: `data and logs/`
  - Naming: `fuelcheck_<mon><year>.csv`
- **Database table:** `dbo.fuelcheck`  
  - Used for historical comparison (last month only)
- **Config file:** `config.json`
  - `latest_file`
- **Command-line arguments:**
  - `--log-file`

## 5. Outputs
- Transformed dataset written to database:
  - Table: `dbo.fuelcheck_staging`
- Workflow logs written to shared log file

## 6. Logic / Steps

### Block 1 – Base Cleaning
1. Initialise module logging using orchestrator-provided log file  
2. Load latest CSV file based on `config.json`
3. Select required columns:
   - `ServiceStationName`
   - `Address`
   - `Brand`
   - `FuelCode`
   - `PriceUpdatedDate`
   - `Price`
4. Fill missing non-price attributes where possible
5. Convert:
   - `PriceUpdatedDate` to `date` (strip time component)

### Block 2 – Entity Resolution
6. From Block 1:
   - Select **distinct** combinations of:
     - `ServiceStationName`
     - `Address`
     - `FuelCode`
7. From database:
   - Load **last month only** records from `dbo.fuelcheck`
   - Select same distinct columns
8. Union both datasets to produce full entity list

### Block 3 – Date Expansion
9. Determine date range:
   - `min_date = earliest PriceUpdatedDate - 1 day`
   - `max_date = latest PriceUpdatedDate`
10. Generate date spine covering full range
11. Cross join:
   - Entity list (Block 2)
   - Date spine
12. Sort by:
   - `ServiceStationName`
   - `Address`
   - `FuelCode`
   - `Date`

### Block 4 – Price Completion
13. Aggregate Block 1 prices:
   - Group by:
     - `ServiceStationName`
     - `Address`
     - `FuelCode`
     - `PriceUpdatedDate`
   - Aggregate:
     - `avg(Price)`
14. Left join aggregated prices to expanded dataset
15. Left join previous month prices (last day only) for backfill seed
16. Forward-fill prices per station and fuel
17. Drop rows with null prices after forward fill
18. Drop records belonging to the previous month
19. Write final dataset to `dbo.fuelcheck_staging`

## 7. Conditional Checks
1. **Missing input file**
   - If expected CSV does not exist
   - Raise exception
2. **Empty dataset**
   - If no rows after transformation
   - Raise exception
3. **Date range sanity**
   - If min date > max date
   - Raise exception

## 8. Error Handling & Logging
- Log entry and exit of each block
- Row counts logged after each major transformation
- Database operations wrapped in `try/except`
- Exceptions logged with stack trace
- Critical failures re-raised for orchestrator handling
